# Аппаратная часть

## Блок АЦП

### Определение количества каналов АЦП
Блок АЦП должен снимать показания со следующих датчиков:
* Датчик тока розетки №1
* Датчик тока розетки №2
* Датчик напряжения
* Другие датчики
Итого блок АЦП должен иметь не менее 4-х каналов.

### Требования к быстродействию АЦП

#### Параметры переменного тока, измеряемые АЦП
SmartSocket обладает функцией оценки качества тока в электрической сети.

Для полной оценки качества переменного тока нужно выполнить все измерения, изложенные
в ГОСТ 32144-2013. Однако, устройство, выполняющее измерения, описанные в стандарте,
является отдельным полноценным проектом.

Для определения потребляемой мощности приборами, подключенными к SmartSocket, нам необходимо
определить следующие параметры сетевого питания:
1) Частоту
2) Напряжение
3) Силу тока

Частота переменного тока в России жестко стандартизована и строго соблюдается
энергетическими компаниями. Соблюдение частоты жизненно необходимо для синхронизации
единой энергетической сети России. ГОСТ гласит:
```
отклонение частоты в синхронизированных системах электроснабжения не должно превышать
+/- 0,2 Гц в течение 95% времени интервала в одну неделю и +/- 0,4 Гц в течение
100% времени интервала в одну неделю
```
Поэтому примем частоту электрической сети равной 50 Гц и в этом проекте не будем её
измерять.

Измерение амплитуды напряжения актуально для России, так как РФ находится в процессе
перехода c 220В на 230В стандарт напряжения, согласно ГОСТ 29322-92. И не ясно в каком
регионе России уже перешли на 230В, а в каком все еще остаются на 220В.

**Итак, в этом проекте мы ограничимся измерением амплитуды сетевого напряжения и тока.**

#### Точность измерений

**Зададим точность измерения амплитуды переменного тока/напряжения 1.6%.**

#### Определение частоты дискретизации АЦП
Так как измерения мы проводим с помощью цифровой техники, то нам нужно преобразовать
непрерывную функцию значений датчика в цифровой вид. Для этого используется дискретизация
сигнала. Мы будем использовать равномерную дискретизацию.

![Дискретизация сигнала](quantization_levels.jpg)

На точность измерения сигнала влияет не только дискретизация сигнала, но и его квантование.
Квантование задается битностью АЦП.

**Примем, что наш АЦП может оцифровывать сигнал с квантованием не хуже 10 бит**

10 бит - это размах сигнала, равный 1024 единицам измерения. Очевидно, что погрешность
измерения равна 1 кванту.

Для сигнала, амплитуда которого равна максимальному измеряемому напряжению погрешность
измерения составит: `P = 100% - ((1024-1)/1024) * 100% = 0.1%`

Для сигнала, амплитуда которого равна `1/4` максимального измеряемого напряжения погрешность
измерения составит: `P = 100% - ((256-1)/256) * 100% = 0.4%`

Для сигнала, амплитуда которого равна `1/8` максимального измеряемого напряжения погрешность
измерения составит: `P = 100% - ((128-1)/128) * 100% = 0.8%`

Возьмем худший вариант, когда измеряемый сигнал равен `1/8` от максимального измеряемого и
погрешность квантования равна `0.8%`.

Определим частоту дискретизации, необходимую для измерения сигнала `1/4` от максимального
измеряемого c суммарной погрешностью 1%:
`1.6% - 0.8% = 0.8%`

![Косинусоида](cos.gif)

```
y = COS(x)

0.992 = COS(X)
X = ACOS(0.992) = 0.13

0.02 - 2Pi
T/2  - 0.13
T/2 = (0.02 * 0.13) / 2Pi
T   = (0.02 * 0.13) / Pi = 0.0008

Freq = 1/T = 1/0.0008 = 1200 Гц
```

### Выбор варианта реализации АЦП
В качестве длока АЦП можно задействовать следующие технические решения:
1) Использовать имеющийся АЦП в МК ESP8266, дополнив его аналоговым
   мультиплексором: CD74HC4067
2) Использовать отдельную схему АЦП: ADS1115, ADS1115
3) В качестве АЦП использовать другой процессор, имеющий требуемое количество аналоговых
   каналов: Atmega168.

| Характеристика            | ESP8266 | ADS1115 | ADS1015 | CD74HC4067 | Atmega168 | STM32F103 |
| --- | :---: | :---: | :---: | :---: | :---: | :---: |
| Колво АЦП                 | 1       | 1       | 1       | 1(ESP8266) | 1         | 2         |
| Колво аналог каналов      | 1       | 4       | 4       | 16         | 8         | 16        |
| Разрядность, бит          | 10      | 16      | 12      | 10(ESP8266)| 10        | 12        |
| Скорость сэмпл, sps       | ?       | 860     | 3300    | ?          | 15000     | 60000     |
| Скорость сэмпл на канал   | ?       | 215     | 825     | ?          | 1875      | 7500      |
| Колво пинов интерфейса MK | 1       | 2 (I2C) | 2 (I2C) | 4+1 (bin)  | 1 (Tx)    | 1 (TX)    |
| Стоимость модуля, руб     | 0       | 109     | 120     | 48         | 115       | 108       |

Для нашей задачи на роль блока АЦП подходит Atmega168, так как он:
* имеет достаточное количество каналов (с запасом)
* имеет достаточную скорость сэмплирования
* имеет стоимость модуля на уровне конкурентов
* для связи с CPU использует 1 пин (режим передачи телеметрии)
* может выполнить функцию цифрового мультиплексора (режим приема команд + 1 Rx пин)
* может выполнить функцию предварительного расчета параметров сигнала
  (минимум, максимум, TrueRMS)

К сожалению АЦП ESP8266 использовать для задач измерения переменного напряжения с заданной
точностью нельзя, так как производитель не указывает максимальную скорость сэмплирования АЦП.

> **Лучшим вариантом на роль блока АЦП является MK STM32F103, но автор работы не смог вовремя
  освоить технологию программирования STM32 процессоров.**

# Программная часть

## Выбор режима работы АЦП Atmega168

### Коммутация АЦП с аналоговыми портами
МК Atmega168 содержит один АЦП, который с помощью коммутатора может подключаться к любому
из 8 аналоговых выводов. В каждый момент времени аналого-цифровое преобразование производится
только на одном аналогом выводе.

Чтобы оцифровать сигналы со всех 8 аналоговых выводов, нужно циклически переключать АЦП
с одного вывода на другой с помощью мультиплексора и производить оцифровку сигнала
с каждого вывода по отдельности.

### Режимы работы АЦП
АЦП в МК Atmega168 работает в режимах:
* First conversion - 25 тактов
* Single conversion mode - 12.5 тактов
* Free running conversion mode - 12.5 тактов

![Временная диаграмма First conversion mode](adc_first_sm.jpg)

В режиме одиночного преобразования АЦП затрачивает на преобразование 25 циклов, а в режимах
Single conversion mode и Free running conversion mode по 12.5.
Free running mode отличается от Single running mode тем, что оцифровка сигнала идет
постоянно с промежутком между преобразованиями в 1 такт.

### Эквивалентная схема входной цепи АЦП
![Эквивалентная схема входной цепи АЦП](adc_guts_sm1.jpg)

Входная цепь АЦП состоит из:
* Мультиплексора
* Мультиплексорного конденсматора
* Конденсатора удержания
* АЦП
* Ключа, отключающего цепь конденсатор удержания - АЦП от мультиплексора

![Временная диаграмма Single conversion mode](adc_retrig_sm.jpg)

Согласно временным диаграмам, процессор подключает конденсатор удержания к цепям мультиплексора,
ждет некоторое время, чтобы конденсатор зарядился. Затем конденсатор удержания отключается
от цепей мультиплексора и происходит аналого-цифровое преобразование. После преобразования
конденсотор удержания снова подключается к цепям мультиплексора для выравнивания заряда.

> **Чтобы выровнять заряд конденсатора удержания, требуется время, т.к. в цепи присутствует
резистор 12k.**


### Single conversion mode
В данном проекте требуется оцифровывать сигнал со всех 8 аналоговых выводов. Для этого
нужно циклически переключать АЦП с одного аналогового вывода, на следующий с помощью
мультиплексора.

![Временная диаграмма Free running conversion mode](adc_auto_sm.jpg)

Для такого алгоритма снятия показаний с аналоговых выводов режим Free running mode не подходит,
так как конденсатор удержания не может выровнять заряд за 2 такта. Режим Free running mode
эффективен, когда нужно непрерывно оцифровывать сигнал с одного аналогового пина.

> **Для циклической оцифровки сигналов с нескольких аналоговых пинов хорошо подходит режим
Single conversion mode, когда между аналого-цифровыми преобразованиями проходит несколько
тактов (примерно 12, судя по режиму First conversion), за которые конденсатор удержания
успевает выровнять заряд с исследуемым сигналом.**









# Литература
* http://www.ti.com/lit/ds/symlink/ads1115.pdf
* http://www.ti.com/lit/ds/symlink/ads1015.pdf
* http://www.ti.com/lit/gpn/cd74hc4067
* http://espressif.com/sites/default/files/documentation/0a-esp8266ex_datasheet_en.pdf
* http://www.atmel.com/Images/Atmel-9365-Automotive-Microcontrollers-ATmega88-ATmega168_Datasheet.pdf
* http://www.st.com/content/ccc/resource/technical/document/datasheet/33/d4/6f/1d/df/0b/4c/6d/CD00161566.pdf/files/CD00161566.pdf/jcr:content/translations/en.CD00161566.pdf
* https://arduinonsk.ru/blog/94-perevod-overklokking-atsp-i-semplirovanie-vysokoimpedansnykh-istochnikov
