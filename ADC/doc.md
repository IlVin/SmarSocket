# Аппаратная часть

## Блок АЦП

### Определение количества каналов АЦП
Блок АЦП должен снимать показания со следующих датчиков:
* Датчик тока розетки №1
* Датчик тока розетки №2
* Датчик напряжения
* Другие датчики
Итого блок АЦП должен иметь не менее 4-х каналов.

### Требования к быстродействию АЦП

#### Параметры переменного тока, измеряемые АЦП
SmartSocket обладает функцией оценки качества тока в электрической сети.

Для полной оценки качества переменного тока нужно выполнить все измерения, изложенные
в ГОСТ 32144-2013. Однако, устройство, выполняющее измерения, описанные в стандарте,
является отдельным полноценным проектом.

Для определения потребляемой мощности приборами, подключенными к SmartSocket, нам необходимо
определить следующие параметры сетевого питания:
1) Частоту
2) Напряжение
3) Силу тока

Частота переменного тока в России жестко стандартизована и строго соблюдается
энергетическими компаниями. Соблюдение частоты жизненно необходимо для синхронизации
единой энергетической сети России. ГОСТ гласит:
```
отклонение частоты в синхронизированных системах электроснабжения не должно превышать
+/- 0,2 Гц в течение 95% времени интервала в одну неделю и +/- 0,4 Гц в течение
100% времени интервала в одну неделю
```
Поэтому примем частоту электрической сети равной 50 Гц и в этом проекте не будем её
измерять.

Измерение амплитуды напряжения актуально для России, так как РФ находится в процессе
перехода c 220В на 230В стандарт напряжения, согласно ГОСТ 29322-92. И не ясно в каком
регионе России уже перешли на 230В, а в каком все еще остаются на 220В.

**Итак, в этом проекте мы ограничимся измерением амплитуды сетевого напряжения и тока.**

#### Точность измерений

**Зададим точность измерения амплитуды переменного тока/напряжения 1.6%.**

#### Определение частоты дискретизации АЦП
Так как измерения мы проводим с помощью цифровой техники, то нам нужно преобразовать
непрерывную функцию значений датчика в цифровой вид. Для этого используется дискретизация
сигнала. Мы будем использовать равномерную дискретизацию.

![Дискретизация сигнала](quantization_levels.jpg)

На точность измерения сигнала влияет не только дискретизация сигнала, но и его квантование.
Квантование задается битностью АЦП.

**Примем, что наш АЦП может оцифровывать сигнал с квантованием не хуже 10 бит**

10 бит - это размах сигнала, равный 1024 единицам измерения. Очевидно, что погрешность
измерения равна 1 кванту.

Для сигнала, амплитуда которого равна максимальному измеряемому напряжению погрешность
измерения составит: `P = 100% - ((1024-1)/1024) * 100% = 0.1%`

Для сигнала, амплитуда которого равна `1/4` максимального измеряемого напряжения погрешность
измерения составит: `P = 100% - ((256-1)/256) * 100% = 0.4%`

Для сигнала, амплитуда которого равна `1/8` максимального измеряемого напряжения погрешность
измерения составит: `P = 100% - ((128-1)/128) * 100% = 0.8%`

Возьмем худший вариант, когда измеряемый сигнал равен `1/8` от максимального измеряемого и
погрешность квантования равна `0.8%`.

Определим частоту дискретизации, необходимую для измерения сигнала `1/4` от максимального
измеряемого c суммарной погрешностью 1%:
`1% - 0.8% = 0.8%`

![Косинусоида](cos.gif)

```
y = COS(x)

0.992 = COS(X)
X = ACOS(0.992) = 0.13

0.02 - 2Pi
T/2  - 0.13
T/2 = (0.02 * 0.13) / 2Pi
T   = (0.02 * 0.13) / Pi = 0.0008

Freq = 1/T = 1/0.0008 = 1200 Гц
```

### Выбор варианта реализации АЦП
В качестве длока АЦП можно задействовать следующие технические решения:
1) Использовать имеющийся АЦП в МК ESP8266, дополнив его аналоговым
   мультиплексором: CD74HC4067
2) Использовать отдельную схему АЦП: ADS1115, ADS1115
3) В качестве АЦП использовать другой процессор, имеющий требуемое количество аналоговых
   каналов: Atmega168.

| Характеристика         | ESP8266 | ADS1115 | ADS1015 | CD74HC4067 | Atmega168 |
| --- | --- | --- | --- | --- | --- |
| Колво пинов интерфейса | 1       | 2 (I2C) | 2 (I2C) | 4+1 (bin)  | 1 (Tx)    |
| Колво аналог каналов   | 1       | 4       | 4       | 16         | 8         |
| Разрадность, бит       | 10      | 16      | 12      | -          | 10        |
| Скорость сэмпл, sps    | ?       | 860     | 3300    | ?          | 15000     |
| Скорость сэмпл на канал| ?       | 215     | 825     | ?          | 1875      |
| Стоимость модуля, руб  | 0       | 109     | 120     | 48         | 115       |
Для нашей задачи на роль блока АЦП подходит Atmega168, так как он:
* имеет достаточное количество каналов (с запасом)
* имеет достаточную скорость сэмплирования
* имеет стоимость модуля на уровне конкурентов
* для связи с CPU использует 1 пин
* может выполнить функцию мультиплексора

К сожалению АЦП ESP8266 использовать для задач измерения переменного напряжения с заданной
точностью нельзя, так как производитель не указывает максимальную скорость сэмплирования АЦП.

# Программная часть







# Литература
* http://www.ti.com/lit/ds/symlink/ads1115.pdf
* http://www.ti.com/lit/ds/symlink/ads1015.pdf
* http://www.ti.com/lit/gpn/cd74hc4067
* http://espressif.com/sites/default/files/documentation/0a-esp8266ex_datasheet_en.pdf
* http://www.atmel.com/Images/Atmel-9365-Automotive-Microcontrollers-ATmega88-ATmega168_Datasheet.pdf
